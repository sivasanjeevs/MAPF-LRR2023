# MAPF Server Implementation

This implementation adds HTTP server capabilities to the MAPF planner, allowing it to receive planning requests via REST API and return planned paths to clients. It supports running multi-step simulations and generating a final summary report.

## Architecture


Client (Python/curl) → HTTP Server → MAPF Planner → Response


## Components

### 1. MAPFServer Class (`inc/MAPFServer.h`, `src/MAPFServer.cpp`)
- HTTP server implementation using Boost.Beast.
- Handles planning requests, session management, and report generation.
- Manages planner initialization and configuration.

### 2. Server Driver (`src/server_driver.cpp`)
- Command-line interface for the server.
- Handles server startup and shutdown.
- Processes command-line arguments.

### 3. Client Examples
- Python client (`examples/client_example.py`) to run a full simulation.
- Curl examples (`examples/curl_examples.sh`) for single-step testing.

## Building

### Prerequisites
- Boost (including Boost.Beast for HTTP server)
- All existing MAPF dependencies

### Compilation
```bash
./compile.sh

This will create two executables:

build/lifelong - Original simulation driver

build/mapf_server - New HTTP server

Usage
Starting the Server
# Basic usage
./build/mapf_server --mapFile ./example_problems/custom_domain/maps/mymap.map --configFile ./configs/mymap.json

# With custom port
./build/mapf_server --mapFile ./example_problems/custom_domain/maps/mymap.map --configFile ./configs/mymap.json --port 9090

Server Endpoints
1. Health Check
curl http://localhost:8080/health

Response:

{
  "status": "healthy",
  "timestamp": 1234567890
}

2. Server Status
curl http://localhost:8080/status

Response:

{
  "status": "running",
  "map_file": "./example_problems/custom_domain/maps/mymap.map",
  "map_size": [10, 10],
  "port": 8080,
  "uptime": 0
}

3. Reset Simulation Session
Starts a new simulation session, clearing any previous history.

curl -X POST http://localhost:8080/reset

Response:

{
    "status": "success",
    "message": "Simulation history has been reset."
}

4. Planning Request (Single Timestep)
curl -X POST http://localhost:8080/plan \
 -H "Content-Type: application/json" \
 -d '{
   "agents": [
     {"location": 2, "orientation": 0, "timestep": 0},
     {"location": 3, "orientation": 0, "timestep": 0}
   ],
   "goals": [
     {"location": 96, "timestep": 0},
     {"location": 95, "timestep": 0}
   ]
 }'

5. Generate Simulation Report
Generates a summary of the entire session, from the first /plan request after a /reset.

curl http://localhost:8080/report > test.json

The output test.json will be similar in format to the one generated by the lifelong solver.

API Specification
Request Format
Planning Request (POST /plan)
{
  "agents": [
    {
      "location": int,      // Linearized location (row * width + col)
      "orientation": int,   // 0=E, 1=S, 2=W, 3=N (optional, default: 0)
      "timestep": int       // Current timestep (optional, default: 0)
    }
  ],
  "goals": [
    {
      "location": int,      // Goal location
      "timestep": int       // Goal timestep (optional, default: 0)
    }
  ]
}

Response Format
Plan Success Response (POST /plan)
{
  "status": "success",
  "actions": [
    {
      "agent_id": int,
      "action": string,     // "F", "R", "C", "W", "T"
      "new_state": {
        "location": int,
        "orientation": int,
        "timestep": int
      }
    }
  ],
  "num_agents": int,
  "planning_time": float
}

Error Response
{
  "error": "Error Type",
  "message": "Error description"
}

Action Codes
"F" - Forward

"R" - Clockwise rotate

"C" - Counter-clockwise rotate

"W" - Wait

"T" - Not applicable (timeout/missing action)

Client Examples
Python Client (Full Simulation)
The Python client is designed to run a complete, multi-step simulation.

from examples.client_example import MAPFClient

# 1. Initialize client
client = MAPFClient("http://localhost:8080")

# 2. Reset the server for a new session
client.reset_simulation()

# 3. Define initial states and run a simulation loop
current_agents = [
    {"location": 2, "orientation": 0, "timestep": 0},
    {"location": 3, "orientation": 0, "timestep": 0}
]
goals = [
    {"location": 96, "timestep": 0},
    {"location": 95, "timestep": 0}
]

for t in range(10): # Run for 10 timesteps
    result = client.plan_step(current_agents, goals)
    # Update current_agents from result['actions'][i]['new_state']
    # ...

# 4. Get the final report and save it
report = client.get_report()
with open("test.json", "w") as f:
    json.dump(report, f, indent=4)

Curl Examples (Single Step)
# Run the example script for single-step tests
chmod +x examples/curl_examples.sh
./examples/curl_examples.sh
